description: "Test Dynamic Knowledge Graph Prompts"

providers:
  - id: openai:gpt-4o-mini
    config:
      temperature: 0

prompts: file://promptfoo_test_runner.py:create_prompt

tests:
  - description: "test model prompt references all csv headers in result using valid json format"
    vars:
      user_prompt: "Identifier (RIC),Company Name,Date,ESG_score,Social_score,Gov_score,Env_score,BVPS,Market_cap,Shares,Industry,Net_income,RETURN_ON_ASSET,QUICK_RATIO,ASSET_GROWTH,FNCL_LVRG,PE_RATIO,Scope_1,Scope_2,CO2_emissions,Energy_use,Water_use,Water_recycle,Toxic_chem_red,Injury_rate,Women_Employees,Human_Rights,Strikes,Turnover_empl,Board_Size,Shareholder_Rights,Board_gen_div,Bribery,Recycling_Initiatives,Total_assets
AAL,American Airlines Group Inc,2021,59.02910721,64.28601828,56.39811612,54.38515247,-11.39725006,10198305438,644015000,Airlines,-1993000000,-3.1032,0.7333,7.1507,34.6286,5.8534,898.9575031,6.470219367,41439616,551629386,1873777.95,,0,,41,1,1,5.8,10,1,20,1,0,66467000000
AAL,American Airlines Group Inc,2020,69.40117811,68.81448509,83.94361492,56.96600148,-14.19130047,10626751115,483888000,Airlines,-8885000000,-14.5652,0.4953,3.3553,34.6286,5.8534,904.2455266,7.364001706,40604000,540190224,1729932.37,,0,,41.618,1,0,5.5,12,1,16.66666667,1,0,62008000000
AAL,American Airlines Group Inc,2019,69.36922798,72.44505934,77.10711045,58.21814638,-0.266147604,10574818306,444269000,Airlines,1686000000,2.7966,0.3045,-0.9657,34.6286,5.8534,916.4750598,7.648632162,39388000,564200000,1627726.3,,0,41.872,41.654,1,1,4.242,13,1,15.38461538,1,0,59995000000
AAL,American Airlines Group Inc,2018,71.63302219,72.04574143,83.06962314,60.68373547,-0.36403898,11198012018,465660000,Airlines,1412000000,2.4911,0.3573,14.7675,34.6286,7.0665,969.3836879,9.117632405,39279000,562000000,1767786.47,,0,41.942,42.452,1,0,5.613,13,1,15.38461538,1,0,60580000000
AAL,American Airlines Group Inc,2017,69.79137149,73.98311797,78.63204572,56.14422918,-1.594557245,11334335643,491692000,Airlines,2105000000,2.464,0.4439,2.9469,34.6286,9.8649,1015.247621,10.31959014,42038000,617300000,1608799.25,,0,30.7,42.505,1,0,7.139,13,1,15.38461538,1,0,52785000000
AAL,American Airlines Group Inc,2016,70.3178445,78.15023537,71.82041582,58.46912521,6.853060249,11009755584,556099000,Airlines,2584000000,5.3687,0.5733,5.9052,10.5827,8.1442,979.2028136,12.16881594,42282000,619000000,1767786.47,,0,38.95,42,1,0,,11,1,9.090909091,1,0,51274000000
AAL,American Airlines Group Inc,2015,51.79390641,54.30943132,35.94845361,62.8321256,8.430668783,10802024347,687355000,Airlines,7610000000,16.6085,0.5644,12.0069,11.9697,4.2243,1581.72232,,42300000,,,56781.15,0,,41,0,0,,12,1,8.333333333,1,0,48415000000
AAL,American Airlines Group Inc,2014,44.30935231,52.95317347,34.85299977,41.3372859,2.816897482,11314860839,734016000,Airlines,2882000000,6.7413,0.677,2.2399,28.1404,10.4955,1074.834037,18.58780929,27177000,389700000,1935858.67,98420.66,0,,41,0,1,,11,1,18.18181818,1,0,43225000000
AAL,American Airlines Group Inc,2013,46.85202135,51.25924607,31.05261636,55.31655844,-16.74987427,11600491291,163046000,Airlines,-1834000000,-5.5755,0.7831,79.8299,28.1404,,1128.904458,19.30856166,27533000,394700000,2018280.61,,0,,39,0,0,,11,1,18.18181818,1,0,42278000000
AAL,American Airlines Group Inc,2012,51.24684551,70.86964887,24.12375195,49.64136041,-63.778138,11797714591,125231000,Airlines,-1876000000,-7.9226,0.5391,-1.4173,28.1404,,,,27400000,469631498,2022924,,1,,39,0,0,,12,1,16.66666667,1,0,23510000000
ALK,Alaska Air Group Inc,2021,50.48254945,39.63992514,86.0630969,32.64819037,30.39268209,6474416945,126775000,Airlines,464000000,3.4147,0.9176,-0.6763,4.1239,10.5475,905.4543902,2.884637285,7976125,107090478,59089.504,,0,28.803,,1,0,,12,1,41.66666667,1,0,13951000000
ALK,Alaska Air Group Inc,2020,54.76478447,44.82792507,87.86701992,37.97117517,24.20413123,6625511856,123450000,Airlines,-1324000000,-9.7933,0.8912,8.1044,3.6944,10.5475,937.9543804,1.300096805,7761999,112275897,61424.924,,0,27.16,,1,0,,12,1,41.66666667,1,0,14046000000
ALK,Alaska Air Group Inc,2019,54.78086974,47.53378754,83.23838167,38.60978203,35.13169315,6590256377,124289000,Airlines,769000000,6.4338,0.5761,19.0707,2.9578,10.5475,949.2740056,1.254877122,7503475,108025619.5,63348.931,,0,27.506,,1,0,,11,1,36.36363636,1,0,12993000000
ALK,Alaska Air Group Inc,2018,61.10430324,55.14174196,89.29964586,43.45236925,30.43901647,7068723596,123975000,Airlines,437000000,4.0355,0.5445,1.5448,3.0035,13.6321,858.5817722,2.115780591,5099633,73414401,68202.958,,0,32.976,54,1,0,,10,1,40,1,0,10912000000
ALK,Alaska Air Group Inc,2017,64.76905583,67.17896047,85.4188325,42.77115416,28.08190827,7248778365,123854000,Airlines,723000000,9.2718,0.7305,7.8699,3.2402,11.512,862.8063594,1.878885316,4840510,69695200,82806.8,,0,32.853,54,0,0,,11,1,45.45454545,1,0,10746000000
ALK,Alaska Air Group Inc,2016,55.66218011,51.08911554,87.34169898,32.98313322,23.72184498,7076278341,124389000,Airlines,797000000,9.5683,0.7424,52.5574,3.0872,12.3738,,,,,,,,,,,,,,,,,,9962000000
ALK,Alaska Air Group Inc,2015,,,,,18.78120789,7028431619,129372000,Airlines,848000000,13.4667,0.8532,7.6847,2.7752,12.0625,,,,,,,,,,,,,,,,,,6533000000
ALK,Alaska Air Group Inc,2014,,,,,15.70379121,7281515596,136801000,Airlines,605000000,10.1664,0.8833,3.8712,2.8638,14.7979,,,,,,,,,,,,,,,,,,6064000000
ALK,Alaska Air Group Inc,2013,,,,,14.50217997,7402391525,141878000,Airlines,508000000,8.9571,0.938,6.049,3.2878,13.6386,,,,,,,,,,,,,,,,,,5838000000
ALK,Alaska Air Group Inc,2012,,,,,10.04836794,7414982767,143568000,Airlines,316000000,5.922,0.9207,6.5415,4.1125,9.1566,,,,,,,,,,,,,,,,,,5505000000"
      system_prompt_template: "generate-knowledge-graph-model"
      assert:
      - type: is-json
        value:
          required: ["model"]
          type: object
      - type: contains-all
        value:
          - "Identifier"
          - "Company Name"
          - "date"  # date is a relationship, so will have a lowercase 'd'
          - "ESG_score"
          - "Social_score"
          - "Gov_score"
          - "Env_score"
          - "BVPS"
          - "Market_cap"
          - "Shares"
          - "Industry"
          - "Net_income"
          - "RETURN_ON_ASSET"
          - "QUICK_RATIO"
          - "ASSET_GROWTH"
          - "FNCL_LVRG"
          - "PE_RATIO"
          - "Scope_1"
          - "Scope_2"
          - "CO2_emissions"
          - "Energy_use"
          - "Water_use"
          - "Water_recycle"
          - "Toxic_chem_red"
          - "Injury_rate"
          - "Women_Employees"
          - "Human_Rights"
          - "Strikes"
          - "Turnover_empl"
          - "Board_Size"
          - "Shareholder_Rights"
          - "Board_gen_div"
          - "Bribery"
          - "Recycling_Initiatives"
          - "Total_assets"
      - type: contains-all
        value:
          - "Company"
          - "Industry"
          - "Report"
          - "Environment"
          - "Social"
          - "Governance"

#  - description: "test query prompt has ... in result using valid json format"
#    vars:
#      user_prompt_template: "generate-knowledge-graph-query-user-prompt"
#      user_prompt_args:
#        data_model: '{ "model": { "entities": { "Report": { "attributes": [ "ESG_score", "Social_score", "Gov_score", "Env_score", "BVPS", "Market_cap", "Shares", "Net_income", "RETURN_ON_ASSET", "QUICK_RATIO", "ASSET_GROWTH", "FNCL_LVRG", "PE_RATIO", "Scope_1", "Scope_2", "CO2_emissions", "Energy_use", "Water_use", "Water_recycle", "Toxic_chem_red", "Injury_rate", "Women_Employees", "Human_Rights", "Strikes", "Turnover_empl", "Board_Size", "Bribery", "Recycling_Initiatives", "Total_assets" ] }, "Company": { "attributes": [ "Identifier (RIC)", "Company Name", "Industry" ] }, "Environment": { "attributes": [ "CO2_emissions", "Energy_use", "Water_use", "Water_recycle", "Toxic_chem_red" ] }, "Social": { "attributes": [ "Injury_rate", "Women_Employees", "Human_Rights", "Strikes", "Turnover_empl", "Bribery", "Recycling_Initiatives" ] }, "Governance": { "attributes": [ "Board_Size", "Shareholder_Rights", "Board_gen_div" ] }, "Industry": { "attributes": [] } }, "relationships": { "Company": { "HAS_REPORT": "Report", "BELONGS_TO": "Industry" }, "Report": { "HAS_ESG_ENVIRONMENTAL_METRICS": "Environment", "HAS_ESG_SOCIAL_METRICS": "Social", "HAS_ESG_GOVERNANCE_METRICS": "Governance" }, "Report": { "REPORTED_IN": "Company" } } } }'
#        input_data: "Identifier (RIC),Company Name,Date,ESG_score,Social_score,Gov_score,Env_score,BVPS,Market_cap,Shares,Industry,Net_income,RETURN_ON_ASSET,QUICK_RATIO,ASSET_GROWTH,FNCL_LVRG,PE_RATIO,Scope_1,Scope_2,CO2_emissions,Energy_use,Water_use,Water_recycle,Toxic_chem_red,Injury_rate,Women_Employees,Human_Rights,Strikes,Turnover_empl,Board_Size,Shareholder_Rights,Board_gen_div,Bribery,Recycling_Initiatives,Total_assets
#AAL,American Airlines Group Inc,2021,59.02910721,64.28601828,56.39811612,54.38515247,-11.39725006,10198305438,644015000,Airlines,-1993000000,-3.1032,0.7333,7.1507,34.6286,5.8534,898.9575031,6.470219367,41439616,551629386,1873777.95,,0,,41,1,1,5.8,10,1,20,1,0,66467000000
#AAL,American Airlines Group Inc,2020,69.40117811,68.81448509,83.94361492,56.96600148,-14.19130047,10626751115,483888000,Airlines,-8885000000,-14.5652,0.4953,3.3553,34.6286,5.8534,904.2455266,7.364001706,40604000,540190224,1729932.37,,0,,41.618,1,0,5.5,12,1,16.66666667,1,0,62008000000
#AAL,American Airlines Group Inc,2019,69.36922798,72.44505934,77.10711045,58.21814638,-0.266147604,10574818306,444269000,Airlines,1686000000,2.7966,0.3045,-0.9657,34.6286,5.8534,916.4750598,7.648632162,39388000,564200000,1627726.3,,0,41.872,41.654,1,1,4.242,13,1,15.38461538,1,0,59995000000
#AAL,American Airlines Group Inc,2018,71.63302219,72.04574143,83.06962314,60.68373547,-0.36403898,11198012018,465660000,Airlines,1412000000,2.4911,0.3573,14.7675,34.6286,7.0665,969.3836879,9.117632405,39279000,562000000,1767786.47,,0,41.942,42.452,1,0,5.613,13,1,15.38461538,1,0,60580000000
#AAL,American Airlines Group Inc,2017,69.79137149,73.98311797,78.63204572,56.14422918,-1.594557245,11334335643,491692000,Airlines,2105000000,2.464,0.4439,2.9469,34.6286,9.8649,1015.247621,10.31959014,42038000,617300000,1608799.25,,0,30.7,42.505,1,0,7.139,13,1,15.38461538,1,0,52785000000
#AAL,American Airlines Group Inc,2016,70.3178445,78.15023537,71.82041582,58.46912521,6.853060249,11009755584,556099000,Airlines,2584000000,5.3687,0.5733,5.9052,10.5827,8.1442,979.2028136,12.16881594,42282000,619000000,1767786.47,,0,38.95,42,1,0,,11,1,9.090909091,1,0,51274000000
#AAL,American Airlines Group Inc,2015,51.79390641,54.30943132,35.94845361,62.8321256,8.430668783,10802024347,687355000,Airlines,7610000000,16.6085,0.5644,12.0069,11.9697,4.2243,1581.72232,,42300000,,,56781.15,0,,41,0,0,,12,1,8.333333333,1,0,48415000000
#AAL,American Airlines Group Inc,2014,44.30935231,52.95317347,34.85299977,41.3372859,2.816897482,11314860839,734016000,Airlines,2882000000,6.7413,0.677,2.2399,28.1404,10.4955,1074.834037,18.58780929,27177000,389700000,1935858.67,98420.66,0,,41,0,1,,11,1,18.18181818,1,0,43225000000
#AAL,American Airlines Group Inc,2013,46.85202135,51.25924607,31.05261636,55.31655844,-16.74987427,11600491291,163046000,Airlines,-1834000000,-5.5755,0.7831,79.8299,28.1404,,1128.904458,19.30856166,27533000,394700000,2018280.61,,0,,39,0,0,,11,1,18.18181818,1,0,42278000000
#AAL,American Airlines Group Inc,2012,51.24684551,70.86964887,24.12375195,49.64136041,-63.778138,11797714591,125231000,Airlines,-1876000000,-7.9226,0.5391,-1.4173,28.1404,,,,27400000,469631498,2022924,,1,,39,0,0,,12,1,16.66666667,1,0,23510000000
#ALK,Alaska Air Group Inc,2021,50.48254945,39.63992514,86.0630969,32.64819037,30.39268209,6474416945,126775000,Airlines,464000000,3.4147,0.9176,-0.6763,4.1239,10.5475,905.4543902,2.884637285,7976125,107090478,59089.504,,0,28.803,,1,0,,12,1,41.66666667,1,0,13951000000
#ALK,Alaska Air Group Inc,2020,54.76478447,44.82792507,87.86701992,37.97117517,24.20413123,6625511856,123450000,Airlines,-1324000000,-9.7933,0.8912,8.1044,3.6944,10.5475,937.9543804,1.300096805,7761999,112275897,61424.924,,0,27.16,,1,0,,12,1,41.66666667,1,0,14046000000
#ALK,Alaska Air Group Inc,2019,54.78086974,47.53378754,83.23838167,38.60978203,35.13169315,6590256377,124289000,Airlines,769000000,6.4338,0.5761,19.0707,2.9578,10.5475,949.2740056,1.254877122,7503475,108025619.5,63348.931,,0,27.506,,1,0,,11,1,36.36363636,1,0,12993000000
#ALK,Alaska Air Group Inc,2018,61.10430324,55.14174196,89.29964586,43.45236925,30.43901647,7068723596,123975000,Airlines,437000000,4.0355,0.5445,1.5448,3.0035,13.6321,858.5817722,2.115780591,5099633,73414401,68202.958,,0,32.976,54,1,0,,10,1,40,1,0,10912000000
#ALK,Alaska Air Group Inc,2017,64.76905583,67.17896047,85.4188325,42.77115416,28.08190827,7248778365,123854000,Airlines,723000000,9.2718,0.7305,7.8699,3.2402,11.512,862.8063594,1.878885316,4840510,69695200,82806.8,,0,32.853,54,0,0,,11,1,45.45454545,1,0,10746000000
#ALK,Alaska Air Group Inc,2016,55.66218011,51.08911554,87.34169898,32.98313322,23.72184498,7076278341,124389000,Airlines,797000000,9.5683,0.7424,52.5574,3.0872,12.3738,,,,,,,,,,,,,,,,,,9962000000
#ALK,Alaska Air Group Inc,2015,,,,,18.78120789,7028431619,129372000,Airlines,848000000,13.4667,0.8532,7.6847,2.7752,12.0625,,,,,,,,,,,,,,,,,,6533000000
#ALK,Alaska Air Group Inc,2014,,,,,15.70379121,7281515596,136801000,Airlines,605000000,10.1664,0.8833,3.8712,2.8638,14.7979,,,,,,,,,,,,,,,,,,6064000000
#ALK,Alaska Air Group Inc,2013,,,,,14.50217997,7402391525,141878000,Airlines,508000000,8.9571,0.938,6.049,3.2878,13.6386,,,,,,,,,,,,,,,,,,5838000000
#ALK,Alaska Air Group Inc,2012,,,,,10.04836794,7414982767,143568000,Airlines,316000000,5.922,0.9207,6.5415,4.1125,9.1566,,,,,,,,,,,,,,,,,,5505000000"
#      system_prompt_template: "generate-knowledge-graph-query-system-prompt"
#    assert:
#      - type: is-json
#        value:
#          required: ["cypher_query"]
#          type: object
#      - type: contains-all
#        value:
#          - "COALESCE"
#          - "WITH $data AS data UNWIND data.all_data[1..] AS row WITH data.all_data[0] AS headers, row WITH headers"
#      - type: llm-rubric
#        value: The output "cypher_query" value contains a valid neo4j cypher query, ensuring all columns have been accurately cast to the correct type when compared to the csv_input value
